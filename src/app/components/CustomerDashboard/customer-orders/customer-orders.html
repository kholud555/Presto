<div class="outer-container">
    <div class="inner-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-shopping-bag icon"></i>
                My Orders
            </h1>
            <p class="text-muted mb-0">Track and manage your orders</p>
        </div>

        <!-- Status Timeline Filter -->
        <div class="status-timeline">
            <h5 class="mb-3" style="color: var(--primary-color); font-weight: 600;">
                <i class="fas fa-filter me-2"></i>Filter by Status
            </h5>
            <div class="timeline-container">
                <div class="timeline-line"></div>

                <div class="timeline-step "[ngClass]="SelectStatus==0?'active':''" data-status="0" (click)="FilterOrders(StatusEnum.All)">
                    <div class="step-circle">
                        <i class="fas fa-list"></i>
                    </div>
                    <div class="step-label">All Orders</div>
                </div>

                <div class="timeline-step" [ngClass]="SelectStatus==1?'active':''" data-status="1" (click)="FilterOrders(StatusEnum.WaitingToConfirm)" >
                    <div class="step-circle">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="step-label">Waiting to Confirm</div>
                </div>

                <div class="timeline-step"[ngClass]="SelectStatus==2?'active':''" data-status="2" (click)="FilterOrders(StatusEnum.Preparing)">
                    <div class="step-circle">
                        <i class="fas fa-utensils"></i>
                    </div>
                    <div class="step-label">Preparing</div>
                </div>

                <div class="timeline-step"[ngClass]="SelectStatus==3?'active':''" data-status="3" (click)="FilterOrders(StatusEnum.Out_for_Delivery)">
                    <div class="step-circle">
                        <i class="fas fa-motorcycle"></i>
                    </div>
                    <div class="step-label">Out for Delivery</div>
                </div>

                <div class="timeline-step" [ngClass]="SelectStatus==4?'active':''" data-status="4" (click)="FilterOrders(StatusEnum.Delivered)">
                    <div class="step-circle">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="step-label">Delivered</div>
                </div>
                 <div class="timeline-step"[ngClass]="SelectStatus==5?'active':''" data-status="5" (click)="FilterOrders(StatusEnum.Cancelled)">
                    <div class="step-circle">
                        <i class="fas fa-ban"></i>
                    </div>
                    <div class="step-label">Cancelled</div>
                </div>

            </div>
        </div>

        <!-- Orders Table -->
        <div class="orders-container">
            <div class="table-header">
                <h5 class="mb-0">
                    <i class="fas fa-receipt me-2"></i>Orders List
                </h5>
            </div>

            <div class="table-responsive">
                <table class="table orders-table">
                    <thead>
                        <tr>
                            <th>Order #</th>
                            <th>Restaurant</th>
                            <th>Items</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        @for (item of OrdersView; track $index) {
                        <tr>
                            <td data-label="Order #">#{{item.orderNumber}}</td>
                            <td data-label="Restaurant">{{item.restaurantName}}</td>
                            <td data-label="Items">{{getitems(item.itemNames.$values)}}</td>
                            <td data-label="Date">{{item.orderDate|date}}</td>
                            <td data-label="Status">
                                <span class="order-status"
                                    [ngClass]="item.status==1?'status-waiting':item.status==2?'status-preparing':item.status==3?'status-delivery':item.status==4?'status-delivered':'status-cancelled'">
                                    {{item.status==1?'Waiting':item.status==2?'Preparing':item.status==3?'Out-for-delivery':item.status==4?'Delivered':'Cancelled'}}
                                </span>
                            </td>
                            <td data-label="Total">{{item.totalPrice}}</td>
                            <td data-label="Actions">
                                <button class="btn-icon btn-view" title="View Details"
                                    (click)="openModal('details',item.orderID)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button [style.display]="item.status==4?'inline':'none'" class="btn-icon btn-review" title="Leave Review"
                                    (click)="openModal('review',item.orderID)">
                                    <i class="fas fa-star"></i>
                                </button>

                            </td>
                        </tr>
                        }

                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
<ng-template #ReviewModal>
  <div class="modal fade show d-block">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        
        <!-- Header -->
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-star me-2"></i>
            Leave a Review
          </h5>
          <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
        </div>

        <!-- Body -->
        <div class="modal-body">
          <form (ngSubmit)="submitReview()" #reviewForm="ngForm">
            
            <!-- Rating -->
            <div class="mb-3">
              <label class="form-label">
                <i class="fas fa-star me-2" style="color: var(--primary-color);"></i>Rating
              </label>
              <div class="star-rating">
                <span class="star" *ngFor="let r of [1,2,3,4,5]" 
                      [class.selected]="reviewRating >= r"
                      (click)="reviewRating = r">
                  <i class="fas fa-star"></i>
                </span>
              
              </div>
            </div>

            <!-- Comment -->
            <div class="mb-3">
              <label for="reviewComment" class="form-label">
                <i class="fas fa-comment me-2" style="color: var(--primary-color);"></i>Comment
              </label>
              <textarea class="form-control"
                        id="reviewComment"
                        rows="4"
                        [(ngModel)]="reviewComment"
                        name="comment"
                        placeholder="Share your experience..."></textarea>
            </div>

            <!-- Actions -->
            <div class="text-end">
              <button type="button" class="btn btn-secondary me-2" (click)="closeModal()">Cancel</button>
              <button type="submit" class="btn btn-primary">Submit Review</button>
            </div>
          </form>
        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-orange" (click)="closeModal()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Backdrop -->
  <div class="modal-backdrop fade show"></div>
</ng-template>




<ng-template #DetailsModal>
  <div class="modal fade show d-block" >
    <div class="modal-dialog_details">
   <div #printSection class="modal-content_details"   id="print-section" >
                <div class="modal-header_details" >
                    <h5 class="modal-title_details" id="orderDetailsLabel">
                        <i class="fas fa-receipt"></i>
                        Order Details
                    </h5>
                    <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
                </div>

                <div class="modal-body_details"  >
                    <!-- Loading State (show/hide with JavaScript) -->
                    <div class="loading-container d-none" id="loadingState">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading order details...</div>
                    </div>

                    <!-- Order Content (show when loaded) -->
                    <div id="orderContent">
                        <!-- Order Header Info -->
                        <div class="order-header">
                            <div class="order-info">
                                <div class="info-item">
                                    <div class="info-label">Order #</div>
                                    <div class="info-value">#{{selectedOrderDetails.orderNumber }}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Restaurant</div>
                                    <div class="info-value">{{ selectedOrderDetails.restaurantName }}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Restaurant Location</div>
                                    <div class="info-value">{{ selectedOrderDetails.restaurantLocation }}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Date</div>
                                    <div class="info-value">{{ selectedOrderDetails.orderDate | date:'MMM d, yyyy' }}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Status</div>
                                    <div class="info-value">
                                        <span class="status-badge" [ngClass]="selectedOrderDetails.status==1?'status-waiting':selectedOrderDetails.status==2?'status-preparing':selectedOrderDetails.status==3?'status-delivery':selectedOrderDetails.status==4?'status-delivered':'status-cancelled'">
                                            <i class="fas" [ngClass]="getStatusIcon(selectedOrderDetails.status)"></i>
                                            {{ selectedOrderDetails.status| statustitle:ViewStatusEnum}}
                                        </span>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Order Time</div>
                                    <div class="info-value">{{formatTime(selectedOrderDetails.orderTimeToComplete)}}</div>
                                </div>
                            </div>
                        </div>

                                            <!-- Delivery Section -->
                    <div class="items-section">
                        <h6 class="section-title">
                            <i class="fas fa-motorcycle"></i>
                            Delivery
                        </h6>
                        
                        <div class="delivery-card">
                            <div class="delivery-icon">
                                <i class="fas fa-truck fa-2x" style="color: var(--primary-color);"></i>
                            </div>
                            <div class="delivery-details">
                                <div class="delivery-address">
                                    <div class="delivery-label">Order Delivered To</div>
                                    <div class="delivery-value">{{selectedOrderDetails.customerAddress}}</div>
                                </div>
                                <div class="delivery-info" *ngIf="selectedOrderDetails.status!=1 && selectedOrderDetails.status!=5">
                                    <div class="delivery-person">
                                        <span class="delivery-name">{{selectedOrderDetails.delivaryName}}</span> â€¢ 
                                        <span class="delivery-phone">+2{{selectedOrderDetails.delivaryPhone}}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="delivery-status">
                                <div class="status-indicator">
                                    <i class="fas fa-motorcycle" style="color: var(--primary-color);"></i>
                                </div>
                            </div>
                        </div>
                    </div>


                        <!-- Order Items -->
                        <div class="items-section page-break">
                            <h6 class="section-title">
                                <i class="fas fa-hamburger"></i>
                                Order Items
                            </h6>
                            
                            <div class="items-container">
                                <div class="order-item" *ngFor="let item of selectedOrderDetails.items.$values">
                                    <div class="item-image">
                                        <img [src]="'https://prestoordering.somee.com'+item.imageFile" 
                                             [alt]="item.itemName" 
                                             *ngIf="item.imageFile; else defaultIcon"
                                             style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">
                                        <ng-template #defaultIcon>
                                            <i class="fas fa-utensils fa-2x" style="color: var(--primary-color);"></i>
                                        </ng-template>
                                    </div>
                                    <div class="item-details">
                                        <div class="item-name">{{ item.itemName }}</div>
                                        <div class="item-description" *ngIf="item.preferences">
                                            <strong>Preferences:</strong> {{ item.preferences }}
                                        </div>
                                    </div>
                                    <div class="item-price">
                                        <div class="item-quantity">Qty: {{ item.quantity }}</div>
                                        <div class="item-total">${{ item.totalPrice.toFixed(2) }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Order Summary -->
                        <div class="order-summary page-break">
                            <div class="summary-row">
                                <span class="summary-label">Subtotal:</span>
                                <span class="summary-value">${{ selectedOrderDetails.subTotal.toFixed(2) }}</span>
                            </div>
                            <div class="summary-row">
                                <span class="summary-label">Delivery Fee:</span>
                                <span class="summary-value">${{ selectedOrderDetails.delivaryPrice.toFixed(2) }}</span>
                            </div>
                            <!-- <div class="summary-row" *ngIf="selectedOrderDetails.discountAmount > 0">
                                <span class="summary-label">Discount:</span>
                                <span class="summary-value" style="color: #28a745;">-${{ selectedOrderDetails.discountAmount.toFixed(2) }}</span>
                            </div> -->
                            <div class="summary-row">
                                <span class="summary-label">Total:</span>
                                <span class="summary-value" style="color: var(--primary-color);">${{ selectedOrderDetails.totalPrice.toFixed(2) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer_details">
                    <button type="button" class="btn btn-secondary-custom"(click)="closeModal()">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                    <!-- <button type="button" class="btn btn-primary-custom"  printSectionId="print-section" ngxPrint
                    styleSheetFile="Assets/css/printstyle.css"
                    [openNewTab]="true"
                    
                    printTitle="Order Receipt">

                    
                        <i class="fas fa-print"></i>
                        Print Receipt
                    </button> -->
                      <button type="button" class="btn btn-primary-custom" (click)="printOrder()"  >
                        <i class="fas fa-print"></i>
                        Print Receipt
                    </button>
                  
                    <!-- <button type="button" class="btn btn-primary-custom" *ngIf="selectedOrderDetails.restaurantPhone">
                        <i class="fas fa-phone"></i>
                        Call {{ selectedOrderDetails.restaurantPhone }}
                    </button>
                    <button type="button" class="btn btn-primary-custom" *ngIf="selectedOrderDetails.delivaryName">
                        <i class="fas fa-motorcycle"></i>
                        Track with {{ selectedOrderDetails.delivaryName }}
                    </button> -->
                </div>
            </div>
        </div>
   
       
       
    </div>
  <!-- Backdrop -->
  <div class="modal-backdrop fade show"></div>
</ng-template>


<!-- Second Modal Template -->
<ng-template #ReviewModal>
  <div class="modal fade show d-block">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-star me-2"></i>
                    Leave a Review
                </h5>
          <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
                <form id="reviewForm">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-star me-2" style="color: var(--primary-color);"></i>Rating
                        </label>
                        <div class="star-rating" id="starRating">
                            <span class="star" data-rating="1"><i class="fas fa-star"></i></span>
                            <span class="star" data-rating="2"><i class="fas fa-star"></i></span>
                            <span class="star" data-rating="3"><i class="fas fa-star"></i></span>
                            <span class="star" data-rating="4"><i class="fas fa-star"></i></span>
                            <span class="star" data-rating="5"><i class="fas fa-star"></i></span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="reviewComment" class="form-label">
                            <i class="fas fa-comment me-2" style="color: var(--primary-color);"></i>Comment
                        </label>
                        <textarea class="form-control" id="reviewComment" rows="4"
                            placeholder="Share your experience..."></textarea>
                    </div>

                    <div class="text-end">
                        <button type="button" class="btn btn-secondary me-2" (click)="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Review</button>
                    </div>
                </form>
        </div>
     
      </div>
    </div>
  </div>
  <!-- Backdrop -->
  <div class="modal-backdrop fade show"></div>
</ng-template>


<!-- Render Modals Dynamically -->
<ng-container *ngIf="isDetailsModalOpen" [ngTemplateOutlet]="DetailsModal"></ng-container>
<ng-container *ngIf="isReviewModalOpen" [ngTemplateOutlet]="ReviewModal"></ng-container>